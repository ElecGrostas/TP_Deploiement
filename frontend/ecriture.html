<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Supervision ‚Äì √âcriture</title>

  <!-- Bootstrap + DA globale -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js pour le graphe -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<nav class="navbar navbar-expand-lg shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="./index.html">
      <img src="./img/hub-logo.png" alt="logo" style="height:26px; border-radius:4px;">
      <span>Supervision</span>
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="./config.html">Configuration</a>
      <a class="nav-link" href="./dashboard.html">Dashboard</a>
      <a class="nav-link" href="./export.html">Export</a>
      <a class="nav-link active" href="./ecriture.html">Ecriture</a>
      <a class="nav-link" href="./aide.html">Aide</a>
    </div>
  </div>
</nav>

<div class="container py-5">
  <h2>üîê Mode administrateur</h2>

  <div id="authForm">
    <label>Mot de passe :</label>
    <input type="password" id="adminPass" class="form-control mb-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button class="btn btn-warning" onclick="auth()">Valider</button>
  </div>

  <div id="writePanel" style="display:none;">
    <h4 class="mt-4">√âcrire une valeur</h4>
    <form onsubmit="writeValue(event)">
      <div class="row g-2">
        <div class="col-md-4">
          <label>Variable</label>
          <select id="varSelect" class="form-select">
            <option value="">Chargement.</option>
          </select>
        </div>
        <div class="col-md-4">
          <label>Valeur √† envoyer</label>
          <input type="number" id="valToSend" class="form-control" required>
        </div>
        <div class="col-md-4 d-grid">
          <button type="submit" class="btn btn-warning mt-4">Envoyer</button>
        </div>
      </div>
    </form>

    <hr class="text-secondary">
    <h5 class="mt-4">Graphique en temps r√©el (Variable s√©lectionn√©e)</h5>
    <canvas id="chart" height="150"></canvas>
  </div>
</div>

<script src="./js/api.js"></script>

<script>
  const PASSWORD = "admin"; // Mot de passe simplifi√© pour le test

  // Gestion du login
  async function auth() {
  const pass = document.getElementById("adminPass").value;

  try {
    const r = await fetch("http://localhost:3001/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pass })
    });

    const data = await r.json();

    if (data.success) {
      showPanel();
    } else {
      alert("Mot de passe incorrect");
    }

  } catch (err) {
    alert("Erreur connexion serveur : " + err.message);
  }
}




  function showPanel() {
    document.getElementById("authForm").style.display = "none";
    document.getElementById("writePanel").style.display = "block";
    initPage(); // Chargement des variables une fois logg√©
  }

  // Si d√©j√† connect√© pr√©c√©demment
 // if (localStorage.getItem("admin") === "true") {
 //   showPanel();
 // }

  // Chargement des variables via l'API
  async function initPage() {
    try {
      const variables = await apiGet("/variables");

      const select = document.getElementById("varSelect");
      select.innerHTML = '<option value="">-- Choisir une variable --</option>';

      variables.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = `${v.name} (Reg: ${v.register_address})`;
        select.appendChild(opt);
      });

      // Lance le graphe une fois les variables charg√©es
      drawChart();
    } catch (err) {
      console.error(err);
      alert("Impossible de charger les variables. V√©rifiez que le backend tourne sur le port 3001.");
    }
  }

  // Envoi de la valeur vers /api/variables/:id/write
  async function writeValue(e) {
    e.preventDefault();
    const id = document.getElementById("varSelect").value;
    const val = document.getElementById("valToSend").value;

    if (!id) return alert("Veuillez s√©lectionner une variable");

    try {
      const result = await apiPost(`/variables/${id}/write`, { value: val });
      if (result.success) {
  alert(
    "‚úî √âcriture r√©ussie\n" +
    "Valeur envoy√©e : " + result.written + "\n" +
    "Valeur relue   : " + result.readback + "\n\n" +
    "Debug:\n" +
    "IP : " + result.debug.ip + "\n" +
    "Registre : " + result.debug.addr + "\n" +
    "Type : " + result.debug.type
  );
} else {
  alert("Erreur : " + JSON.stringify(result));
}
console.log("R√©sultat backend:", result);

    } catch (err) {
      alert("Erreur technique : " + err.message);
    }
    
  }

  // Gestion du graphique temps r√©el
  let graph = null;
  function drawChart() {
    const ctx = document.getElementById("chart").getContext("2d");
    graph = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Valeur lue",
          data: [],
          borderColor: "#ff6c00",
          tension: 0.3
        }]
      }
    });


        // Mise √† jour toutes les 2 secondes
    setInterval(async () => {
      const id = document.getElementById("varSelect").value;
      if (!id) return;

      try {
        // On r√©cup√®re la derni√®re valeur via l'API realtime
        const point = await apiGet(`/realtime/${id}`);
        if (point) {
          const time = new Date(point.timestamp).toLocaleTimeString();

          graph.data.labels.push(time);
          graph.data.datasets[0].data.push(point.value);

          if (graph.data.labels.length > 20) {
            graph.data.labels.shift();
            graph.data.datasets[0].data.shift();
          }
          graph.update();
        }
      } catch (e) {
        console.log("Erreur lecture graph", e);
      }
    }, 2000);

  }
</script>
<p class="small-muted mt-4 text-center">
    ¬© 2025 ‚Äì L'Interface de supervision la plus chaude de ta r√©gion ‚Ä¢ √âcriture de Valeurs
  </p>
</body>
</html>
