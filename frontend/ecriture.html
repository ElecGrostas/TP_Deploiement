<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Supervision ‚Äì √âcriture</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/style.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<nav class="navbar navbar-expand-lg shadow-sm" data-aos="fade-down">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="./index.html">
      <img src="./img/hub-logo.png" alt="logo" style="height:26px; border-radius:4px;">
      <span>Supervision</span>
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="./config.html">Configuration</a>
      <a class="nav-link" href="./dashboard.html">Dashboard</a>
      <a class="nav-link" href="./export.html">Export</a>
      <a class="nav-link active" href="./ecriture.html">Ecriture</a>
    </div>
  </div>
</nav>
<body class="bg-dark text-light">

<div class="container py-5">
  <h2>üîê Mode administrateur</h2>

  <div id="authForm">
    <label>Mot de passe :</label>
    <input type="password" id="adminPass" class="form-control mb-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button class="btn btn-warning" onclick="auth()">Valider</button>
  </div>

  <div id="writePanel" style="display:none;">
    <h4 class="mt-4">√âcrire une valeur</h4>
    <form onsubmit="writeValue(event)">
      <div class="row g-2">
        <div class="col-md-4">
          <label>Variable</label>
          <select id="varSelect" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label>Valeur</label>
          <input type="number" id="writeValue" class="form-control" required>
        </div>
        <div class="col-md-4 d-grid">
          <button type="submit" class="btn btn-warning mt-4">Envoyer</button>
        </div>
      </div>
    </form>

    <hr class="text-secondary">
    <h5 class="mt-4">Graphique en temps r√©el</h5>
    <canvas id="chart" height="150"></canvas>
  </div>
</div>

<script>
  const PASSWORD = "admin123"; // √† personnaliser

  function auth() {
    const pass = document.getElementById("adminPass").value;
    if (pass === PASSWORD) {
      localStorage.setItem("admin", "true");
      document.getElementById("authForm").style.display = "none";
      document.getElementById("writePanel").style.display = "block";
      initPage();
    } else {
      alert("Mot de passe incorrect");
    }
  }

  async function initPage() {
    const res = await fetch("/api/variables");
    const variables = await res.json();
    const select = document.getElementById("varSelect");
    variables.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = `${v.name} (${v.unit})`;
      select.appendChild(opt);
    });
    drawChart();
  }

  async function writeValue(e) {
    e.preventDefault();
    const id = varSelect.value;
    const value = writeValue.value;
    const res = await fetch(`/api/variables/${id}/write`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ value })
    });
    const result = await res.json();
    alert(result.success ? "√âcriture r√©ussie" : "Erreur");
  }

  async function drawChart() {
    const ctx = document.getElementById("chart").getContext("2d");
    window.graph = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Valeur",
          data: [],
          borderColor: "#ff6c00"
        }]
      }
    });

    setInterval(async () => {
      const id = varSelect.value;
      if (!id) return;
      const res = await fetch(`/api/history/${id}?limit=1`);
      const data = await res.json();
      if (data.length > 0) {
        graph.data.labels.push(new Date().toLocaleTimeString());
        graph.data.datasets[0].data.push(data[0].value);
        if (graph.data.labels.length > 20) {
          graph.data.labels.shift();
          graph.data.datasets[0].data.shift();
        }
        graph.update();
      }
    }, 2000);
  }

  if (localStorage.getItem("admin") === "true") {
    document.getElementById("authForm").style.display = "none";
    document.getElementById("writePanel").style.display = "block";
    initPage();
  }
</script>
</body>
</html>
